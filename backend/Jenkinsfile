pipeline {
    agent any

    environment {
        IMAGE_NAME = "yourdockerhub/laravel-app"
        GITOPS_REPO = "/tmp/gitops-laravel-react"
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout App Code') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
                          .push()
                }
            }
        }

        stage('Update GitOps Repo (Backend)') {
            steps {
                script {
                    // Clone GitOps repo
                    sh "rm -rf ${GITOPS_REPO}"
                    sh "git clone https://github.com/waseem775/gitops-laravel-react.git ${GITOPS_REPO}"

                    // Update image tag in backend/helm/values.yaml
                    def valuesFile = "${GITOPS_REPO}/backend/helm/values.yaml"
                    sh "sed -i 's|tag:.*|tag: ${IMAGE_TAG}|' ${valuesFile}"

                    // Commit & push
                    dir("${GITOPS_REPO}") {
                        sh """
                          git config user.name "jenkins"
                          git config user.email "jenkins@localhost"
                          git add backend/helm/values.yaml
                          git commit -m 'CI: update backend image tag to ${IMAGE_TAG}'
                          git push origin main
                        """
                    }
                }
            }
        }
    }
}
